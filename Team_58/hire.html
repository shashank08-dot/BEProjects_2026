<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Interview Feed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f8; text-align: center; padding-top: 40px; }
      .video-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 700px;
      height: 520px;
      background-color: #000; /* dark background before video starts */
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      margin: 0 auto 20px;
      position: relative;
    }
      #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    #placeholder {
      position: absolute;
      color: #fff;
      font-size: 1.2rem;
      opacity: 0.7;
    }

  </style>
</head>
<body>

  <div class="container">
    <h2 class="mb-4">ðŸŽ¥ Live Interview Feed</h2>

    <div class="video-container">
      <!-- No src initially -->
         <span id="placeholder">Waiting for video...</span> 
      <img id="video" alt="Webcam Feed">
    </div>

    <!-- âœ… Upload video section -->
    <div class="mt-3">
      <input type="file" id="videoFile" accept="video/*" class="form-control" style="width: 60%; margin: 0 auto;">
      <button class="btn btn-secondary mt-2" id="uploadBtn">Upload Video</button>
    </div>

    <div class="mt-4">
      <button class="btn btn-primary" id="startBtn">Start Processing</button>
      <button class="btn btn-danger" id="stopBtn" disabled>Stop Processing</button>
    </div>

    <div class="mt-4">
      <h4>ðŸ“Š Latest Results</h4>
      <div id="details"></div>
    </div>
  </div>

  <script>
      let videoEl = document.getElementById("video");
      let startBtn = document.getElementById("startBtn");
      let stopBtn = document.getElementById("stopBtn");
      let uploadBtn = document.getElementById("uploadBtn");
      let videoFileInput = document.getElementById("videoFile");
      let placeholder = document.getElementById("placeholder");

      let uploadedVideoPath = null;
      let pollingActive = false; // flag to control polling loop

      uploadBtn.onclick = async () => {
      let file = videoFileInput.files[0];
      if (!file) {
        alert("Please select a video file first!");
        return;
      }

      let formData = new FormData();
      formData.append("video_file", file);

      let res = await fetch("/upload_video", {
        method: "POST",
        body: formData
      });

      let data = await res.json();
      if (data.status === "uploaded") {
        uploadedVideoPath = data.path;
        alert("âœ… Video uploaded successfully! Click Start Processing to begin.");
      } else {
        alert("âŒ Upload failed!");
      }
    };
    // ---------- START PROCESSING ----------
    startBtn.onclick = async () => {
      const res = await fetch("/start_processing");
      const data = await res.json();

      if (data.status === "started") {
        console.log("ðŸŽ¬ Processing started");
      }

      // start webcam feed
      videoEl.src = "/video_feed";
      placeholder.style.display = "none";

      startBtn.disabled = true;
      stopBtn.disabled = false;

      // start polling
      pollingActive = true;
      pollResults();
    };

    stopBtn.onclick =  () => {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      processingStarted = false;

      // Do a normal browser redirect (NOT fetch)
      window.location.href = "/stop_processing";
      
    };
// ---------- POLL SEGMENT RESULTS ----------
    async function pollResults() {
      while (pollingActive) {
        try {
          let res = await fetch("/get_results");
          let data = await res.json();
          
          if (data.status === "finished") {
            pollingActive = false;
            console.log("âœ… Video finished â€” redirecting to summary page");
            window.location.href = "/summary";
            break;
          }

          if (data.status !== "waiting") {
            document.getElementById("details").innerHTML += `<br>Segment: ${(data.segment ?? 0)} | Score: ${(data.score ?? "-")} | Label: ${(data.label ?? "-")}`;
          }
        } catch (err) {
          console.error("Polling error:", err);
        }

        await new Promise(r => setTimeout(r, 1000));
      }
    }
    // ðŸ” Check every 5 seconds if the backend says the uploaded video is done
    setInterval(() => {
      fetch('/check_auto_summary')
        .then(res => res.json())
        .then(data => {
          if (data.ready) {
            console.log("âœ… Video processing completed â€” redirecting to summary...");
            window.location.href = "/summary";
          }
        })
        .catch(err => console.error("Auto-summary check error:", err));
    }, 5000);
  </script>

</body>
</html>